syntax = "proto3";

package aserto.directory.model.v3;

option go_package = "github.com/aserto-dev/go-directory/aserto/directory/model/v3;model";

import "google/protobuf/empty.proto";
import "google/api/annotations.proto";
import "google/api/field_behavior.proto";
import "protoc-gen-openapiv2/options/annotations.proto";

import "aserto/directory/common/v2/common.proto";
import "aserto/directory/common/v3/common.proto";

service Model {
    rpc GetManifest(GetManifestRequest) returns (stream GetManifestResponse) {
        // Binary file downloads are not supported by grpc-gateway.
        // This endpoint is defined manually in openapi-directory.
        // With the options that correspond to the following annotations but the response body
        // is streamed.

        // option (google.api.http) = {
        //     get: "/api/v3/directory/manifest/{name}/{version}"
        // };
        // option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
        //     tags: "directory"
        //     summary: "Get manifest"
        //     description: "Get manifest."
        //     operation_id: "directory.v3.manifest.get"
        //     deprecated: false
        //     security: {
        //         security_requirement: {
        //             key: "TenantID";
        //             value: {}
        //         }
        //         security_requirement: {
        //             key: "DirectoryAPIKey";
        //             value: {}
        //         }
        //     }
        // };
    };
    rpc SetManifest(stream SetManifestRequest) returns (SetManifestResponse) {
        // Binary file uploads are not supported by grpc-gateway.
        // This endpoint is defined manually in openapi-directory.
        // With the options that correspond to the following annotations but the request body is
        // streamed.

        // option (google.api.http) = {
        //     post: "/api/v3/directory/manifest/{name}/{version}"
        // };
        // option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
        //     tags: "directory"
        //     summary: "Set manifest"
        //     description: "Set manifest."
        //     operation_id: "directory.v3.manifest.set"
        //     deprecated: false
        //     security: {
        //         security_requirement: {
        //             key: "TenantID";
        //             value: {}
        //         }
        //         security_requirement: {
        //             key: "DirectoryAPIKey";
        //             value: {}
        //         }
        //     }
        // };
    };
    rpc DeleteManifest(DeleteManifestRequest) returns (DeleteManifestResponse) {
        option (google.api.http) = {
            delete: "/api/v3/directory/manifest/{name}/{version}"
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            tags: "directory"
            summary: "Delete manifest"
            description: "Delete manifest."
            operation_id: "directory.v3.manifest.delete"
            deprecated: false
            security: {
                security_requirement: {
                    key: "TenantID";
                    value: {}
                }
                security_requirement: {
                    key: "DirectoryAPIKey";
                    value: {}
                }
            }
        };
    };
    rpc ListManifests(ListManifestsRequest) returns (ListManifestsResponse) {
        option (google.api.http) = {
            get: "/api/v3/directory/manifests"
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            tags: "directory"
            summary: "List manifests"
            description: "Returns list of stored manifests."
            operation_id: "directory.v3.manifests.list"
            deprecated: false
            security: {
                security_requirement: {
                    key: "TenantID";
                    value: {}
                }
                security_requirement: {
                    key: "DirectoryAPIKey";
                    value: {}
                }
            }
        };
    };
    
    rpc GetObjectType(GetObjectTypeRequest) returns (GetObjectTypeResponse) {
        option (google.api.http) = {
            get: "/api/v3/directory/object_type/{name}"
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            tags: "directory"
            summary: "Get object type"
            description: "Returns single object type."
            operation_id: "directory.v3.object_types.list"
            deprecated: false
            security: {
                security_requirement: {
                    key: "TenantID";
                    value: {}
                }
                security_requirement: {
                    key: "DirectoryAPIKey";
                    value: {}
                }
            }
        };
    };
    rpc GetObjectTypes(GetObjectTypesRequest) returns (GetObjectTypesResponse) {
        option (google.api.http) = {
            get: "/api/v3/directory/object_types"
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            tags: "directory"
            summary: "List all object types"
            description: "Returns list of object types."
            operation_id: "directory.v3.object_types.list"
            deprecated: false
            security: {
                security_requirement: {
                    key: "TenantID";
                    value: {}
                }
                security_requirement: {
                    key: "DirectoryAPIKey";
                    value: {}
                }
            }
        };
    };

    // relation type metadata methods
    rpc GetRelationType(GetRelationTypeRequest) returns (GetRelationTypeResponse) {
        option (google.api.http) = {
            get: "/api/v3/directory/relation_type/{object_type_name}/{name}"
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            tags: "directory"
            summary: "Get relation type for an object type with a given relation name"
            description: "Returns single relation type."
            operation_id: "directory.v3.relation_type.list"
            deprecated: false
            security: {
                security_requirement: {
                    key: "TenantID";
                    value: {}
                }
                security_requirement: {
                    key: "DirectoryAPIKey";
                    value: {}
                }
            }
        };
    };
    rpc GetRelationTypes(GetRelationTypesRequest) returns (GetRelationTypesResponse) {
        option (google.api.http) = {
            get: "/api/v3/directory/relation_types/{object_type_name}"
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            tags: "directory"
            summary: "Get relation types for an object type"
            description: "Returns list of relation types."
            operation_id: "directory.v3.relation_types.list"
            deprecated: false
            security: {
                security_requirement: {
                    key: "TenantID";
                    value: {}
                }
                security_requirement: {
                    key: "DirectoryAPIKey";
                    value: {}
                }
            }
        };
    };

    // permission metadata methods
    rpc GetPermission(GetPermissionRequest) returns (GetPermissionResponse) {
        option (google.api.http) = {
            get: "/api/v3/directory/permission/{name}"
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            tags: "directory"
            summary: "Get a permission"
            description: "Returns single permission."
            operation_id: "directory.v3.permission.list"
            deprecated: false
            security: {
                security_requirement: {
                    key: "TenantID";
                    value: {}
                }
                security_requirement: {
                    key: "DirectoryAPIKey";
                    value: {}
                }
            }
        };
    };
    rpc GetPermissions(GetPermissionsRequest) returns (GetPermissionsResponse) {
        option (google.api.http) = {
            get: "/api/v3/directory/permissions"
        };
        option (grpc.gateway.protoc_gen_openapiv2.options.openapiv2_operation) = {
            tags: "directory"
            summary: "Get all permissions"
            description: "Returns a list of permissions."
            operation_id: "directory.v3.permission.list"
            deprecated: false
            security: {
                security_requirement: {
                    key: "TenantID";
                    value: {}
                }
                security_requirement: {
                    key: "DirectoryAPIKey";
                    value: {}
                }
            }
        };
    };
}

message GetManifestRequest {
   // manifest name (unique, lc-string)
   string  name                                                 = 1      [(google.api.field_behavior) = REQUIRED];
   // manifest version (semver notation)
   string  version                                              = 2      [(google.api.field_behavior) = REQUIRED];
}

message GetManifestResponse {
    oneof msg {
        // Manifest metadata
        Metadata metadata                                       = 1;
        // Manifest content
        bytes   body                                            = 2;
    }
}

message SetManifestRequest {
    // manifest instance
    oneof msg {
        // Manifest metadata
        Metadata metadata                                       = 1;
        // Manifest content
        bytes   body                                            = 2;
    }
}

message SetManifestResponse {
    // empty result
    google.protobuf.Empty result                                = 1;
}

message DeleteManifestRequest {
    // manifest name (unique, lc-string)
   string  name                                                 = 1      [(google.api.field_behavior) = REQUIRED];
   // manifest version (semver notation)
   string  version                                              = 2      [(google.api.field_behavior) = REQUIRED];
}

message DeleteManifestResponse {
    // empty result
    google.protobuf.Empty result                                = 1;
}

message ListManifestsRequest {
    // pagination request
    aserto.directory.common.v3.PaginationRequest page           = 9      [(google.api.field_behavior) = OPTIONAL];
}

message ListManifestsResponse {
    // manifests metadata
    repeated Metadata manifests                                 = 1;
    // pagination response
    aserto.directory.common.v3.PaginationResponse page          = 9;
}

message GetObjectTypeRequest {
    // object type selector
    aserto.directory.common.v2.ObjectTypeIdentifier param       = 1;
}

message GetObjectTypeResponse {
    // object type instance
    aserto.directory.common.v2.ObjectType result                = 1;
}

message GetObjectTypesRequest {
    // pagination request
    aserto.directory.common.v2.PaginationRequest page           = 9;
}

message GetObjectTypesResponse {
    // array of object types
    repeated aserto.directory.common.v2.ObjectType results      = 1;
    // pagination response
    aserto.directory.common.v2.PaginationResponse page          = 9;
}

message GetRelationTypeRequest {
    // relation type selector
    aserto.directory.common.v2.RelationTypeIdentifier param     = 1;
}

message GetRelationTypeResponse {
    // relation type instance
    aserto.directory.common.v2.RelationType result              = 1;
}

message GetRelationTypesRequest {
    // object type selector
    aserto.directory.common.v2.ObjectTypeIdentifier param       = 1;
    // pagination request
    aserto.directory.common.v2.PaginationRequest page           = 9;
}

message GetRelationTypesResponse {
    // array of relation types
    repeated aserto.directory.common.v2.RelationType results    = 1;
    // pagination response
    aserto.directory.common.v2.PaginationResponse page          = 9;
}

message GetPermissionRequest {
    // permission selector
    aserto.directory.common.v2.PermissionIdentifier param       = 1;
}

message GetPermissionResponse {
    // permission instance
    aserto.directory.common.v2.Permission result                = 1;
}

message GetPermissionsRequest {
    // pagination request
    aserto.directory.common.v2.PaginationRequest page           = 9;
}

message GetPermissionsResponse {
    // array of permissions
    repeated aserto.directory.common.v2.Permission results      = 1;
    // pagination response
    aserto.directory.common.v2.PaginationResponse page          = 9;
}


message Metadata {
    // manifest name (unique, lc-string)
    string  name                                                = 1      [(google.api.field_behavior) = REQUIRED];
    // manifest version (semver notation)
    string  version                                             = 2      [(google.api.field_behavior) = REQUIRED];
}

